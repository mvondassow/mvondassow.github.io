/**!
 * Guesstimator
 * http://mvondassow.github.io/
 * Version: 0.1.0
 *
 * Copyright 2018 Michelangelo von Dassow
 */
var guesstimator={copyright:"(c) Michelangelo von Dassow, 2018. All rights reserved.",version:"0.1.0"};guesstimator.distributions={nDelta:function(n,params){var k,out=[];for(k=0;k<n;k++)out.push(params[0]);return out},nRandUniform:function(n,params){var k,width=params[1]-params[0],lb=params[0],out=[];for(k=0;k<n;k++)out.push(width*Math.random()+lb);return out},nRandTrnsNorm:function(m,params,transformFunction){var k,r1,r2,f,mu=params[0],sigma=params[1],out=[];if(transformFunction){if("function"!=typeof transformFunction)throw new Error("'transformFunction' argument for nRandTrnsNorm should be a function, blank, or falsy");f=transformFunction}else f=function(x){return x};for(k=0;k<m/2;k++)r1=sigma*Math.pow(-2*Math.log(Math.random()),.5),r2=2*Math.PI*Math.random(),out.push(f(mu+r1*Math.sin(r2))),out.push(f(mu+r1*Math.cos(r2)));return out.length>m&&out.pop(),out}},guesstimator.distributions.nRandNorm=function(m,params){return guesstimator.distributions.nRandTrnsNorm(m,params)},guesstimator.distributions.nRandLognorm=function(m,params){return guesstimator.distributions.nRandTrnsNorm(m,params,Math.exp)},guesstimator.elementByElement=function(a,b,fun){var out=[],k,arr,scal,kmax=a.length||b.length;if("function"!=typeof fun)throw new Error("Third argument to 'elementByElement' must be a function");if(Array.isArray(a)&&Array.isArray(b)&&a.length===b.length)for(k=0;k<kmax;k++)out.push(fun(a[k],b[k]));else if("number"==typeof a&&"number"==typeof b)out=fun(a,b);else if(Array.isArray(a)&&"number"==typeof b)for(k=0;k<kmax;k++)out.push(fun(a[k],b));else{if("number"!=typeof a||!Array.isArray(b))throw new Error("elementByElement expects two equal length arrays, two numbers, or an array and a number");for(k=0;k<kmax;k++)out.push(fun(a,b[k]))}return out},guesstimator.mult=function(a,b){return guesstimator.elementByElement(a,b,function(x,y){return x*y})},guesstimator.add=function(a,b){return guesstimator.elementByElement(a,b,function(x,y){return x+y})},guesstimator.subt=function(a,b){return guesstimator.elementByElement(a,b,function(x,y){return x-y})},guesstimator.mean=function(arr){return Array.isArray(arr)?arr.reduce(function(total,x){return total+x},0)/arr.length:"number"==typeof arr?arr:Number.NaN},guesstimator.sqr=function(x){return x*x},guesstimator.sumOfSqrs=function(arr){return Array.isArray(arr)?arr.reduce(function(total,x){return total+x*x},0):"number"==typeof arr?arr*arr:Number.NaN},guesstimator.variance=function(arr){return Array.isArray(arr)?(guesstimator.sumOfSqrs(arr)-arr.length*guesstimator.sqr(guesstimator.mean(arr)))/(arr.length-1):Number.NaN},guesstimator.stdev=function(arr){return Math.pow(guesstimator.variance(arr),.5)},guesstimator.lognormFromMeanAndVariance=function(m,v){return[Math.log(m/Math.pow(1+v/(m*m),.5)),Math.log(1+v/(m*m))]},guesstimator.lognormFrom10thAnd90thPercentiles=function(p10p90){var ex10=Math.log(p10p90[0]),ex90=Math.log(p10p90[1]),normMean=(ex10+ex90)/2,normSD;return[normMean,(ex90-normMean)/1.282]},guesstimator.timeTest=function(ms){var t0,k=0,n=100,arr0,arr1;for(t0=Date.now();Date.now()-t0<ms;)arr0=guesstimator.distributions.nRandLognorm(n,[0,.2]),arr1=guesstimator.distributions.nRandLognorm(n,[0,.2]),guesstimator.add(arr0,arr1),k++;return k*n},guesstimator.binData=function(arr,rng,kmax,scale){var out={bins:[],counts:[]},k,j,jmax=arr.length,width=Math.abs((rng[1]-rng[0])/kmax),xmin=Math.min(rng[0],rng[1]),h;for(k=0;k<=kmax;k++)out.bins.push(xmin+k*width),out.counts.push(0);if(out.bins.push(Number.POSITIVE_INFINITY),out.counts.push(0),jmax)for(j=0;j<jmax;j++)k=Math.min(kmax+1,Math.max(0,Math.ceil((arr[j]-xmin)/width))),out.counts[k]+=1;else"number"==typeof arr&&(k=Math.min(kmax+1,Math.max(0,Math.ceil((arr-xmin)/width))),out.counts[k]+=1);return"normalize"===scale&&(h=Math.max.apply(null,out.counts),out.counts=out.counts.map(function(x){return x/h})),out},guesstimator.hexToRGBA=function(str,op){var s,sl=str.length,step,rgba=[],k;if("string"!=typeof str||7!==sl&&4!==sl&&"#"!==str[0])throw new Error("Not valid hex color string beginning with '#'");if(void 0!==op&&(isNaN(op)||op>1||op<0))throw new Error("Opacity 'num' should be between 0 and 1");for(step=(sl-=1)/3,s=str.replace("#",""),k=0;k<sl;k+=step)rgba.push(parseInt(6===sl?s[k]+s[k+1]:s[k],16));return op=void 0===op?1:op,rgba.push(op),"rgba("+rgba.join(",")+")"},guesstimator.isValidNum=function(x){return void 0!==x&&!isNaN(x)},guesstimator.appendCanvas=function(el){var cvs=document.createElement("canvas");return el.appendChild(cvs),cvs.getContext("2d")},guesstimator.plot={},guesstimator.plot.histogram=function(obj){var ctx=guesstimator.appendCanvas(obj.chartElement);return obj.options=obj.options||{},obj.options.border="string"==typeof obj.options.border?obj.options.border:"1px solid #000000;",ctx.canvas.setAttribute("style","border:"+obj.options.border),function(){var bins,seriesName,seriesData,allSeries=[],binCount=obj.options.binCount?obj.options.binCount:Math.max(obj.n/100,10),curSeries;for(seriesName in ctx.canvas.title=obj.options.canvasTitle||"Plot shows fraction of outcomes predicted to fall within each cost bin.",obj.plotSeries){if(curSeries=obj.plotSeries[seriesName],seriesData=guesstimator.binData(curSeries.vals,obj.range,binCount,"normalize"),bins){if(!seriesData.bins.every(function(x,k){return x===bins[k]}))throw new Error("Error in binning data: bins don't match for all series")}else bins=seriesData.bins;allSeries.push({data:seriesData.counts,label:seriesName,borderColor:curSeries.color||"#000000",backgroundColor:guesstimator.hexToRGBA(curSeries.color||"#000000",guesstimator.isValidNum(curSeries.opacity)?curSeries.opacity:.4),pointRadius:0,borderWidth:guesstimator.isValidNum(curSeries.borderWidth)?curSeries.borderWidth:1,showLine:!0,lineTension:0})}bins[bins.length-1]=bins[bins.length-2],bins=guesstimator.formatLabels(bins,guesstimator.deepMerge({firstTick:{prefix:"≤"},lastTick:{prefix:"≥"}},obj.options.labels||{})),obj.chart?(obj.chart.data={labels:bins,datasets:allSeries},obj.chart.update()):obj.chart=new Chart(ctx,{type:"line",data:{labels:bins,datasets:allSeries},options:{tooltips:{enabled:obj.options.showToolTips},scales:{yAxes:[{type:"linear",display:!0,gridLines:{display:!1},ticks:{min:0,max:1.1,callback:function(tickVal,tickInd,ticks){return 0===tickInd?"High":tickInd===ticks.length-1?"Low":""}},scaleLabel:{labelString:obj.options.hasOwnProperty("yLabel")?obj.options.yLabel:"",display:!0}}],xAxes:[{display:!0,gridLines:{display:!1,tickMarkLength:10},ticks:{maxTicksLimit:obj.options.maxTicksLimit||9},scaleLabel:{labelString:obj.options.hasOwnProperty("xLabel")?obj.options.xLabel:"",display:!0}}]},animation:{duration:0},hover:{animationDuration:0},responsiveAnimationDuration:0}})}},guesstimator.plot.scatter=function(obj){var delayFun,ctx=guesstimator.appendCanvas(obj.chartElement);function createPlot(){var opts=guesstimator.deepMerge({pointRadius:1,backgroundColor:"#fff",axisColor:"#000",opacity:1,minCanvasHeight:150,canvasAspectRatio:.5,borderProportion:.1,minLateralBorder:15,minTopBorder:25,minBottomBorder:45,lineWidth:2,maxTicksLimit:2,showSeries:"Total",labels:{firstTick:{prefix:"≤"},lastTick:{prefix:"≥"}},xLabel:"",chartTitle:"",canvasTitle:"Each point represents one possible outcome.",fonts:"Arial, Helvetica, sans-serif"},obj.options),arr=obj.plotSeries[opts.showSeries].vals,pointColor=guesstimator.hexToRGBA(obj.plotSeries[opts.showSeries].color,opts.opacity),k,kmax,labels,fullTitle,borders={};for(ctx.canvas.title=opts.canvasTitle,ctx.canvas.width=Math.min(obj.chartElement.clientWidth,guesstimator.getWindowWidth()),ctx.canvas.height=Math.max(opts.minCanvasHeight,opts.canvasAspectRatio*ctx.canvas.width),borders.top=Math.max(opts.borderProportion*ctx.canvas.height,opts.minTopBorder),borders.bottom=Math.max(opts.borderProportion*ctx.canvas.height,opts.minBottomBorder),borders.lateral=Math.max(opts.borderProportion*ctx.canvas.width,opts.minLateralBorder),tr=guesstimator.genScalings([obj.range[0],borders.lateral],[0,ctx.canvas.height-borders.bottom],[obj.range[1],ctx.canvas.width-borders.lateral],[1,borders.top]),ctx.fillStyle=opts.backgroundColor,ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.beginPath(),ctx.lineWidth=opts.lineWidth,ctx.strokeStyle=opts.axisColor,ctx.moveTo(tr.x(obj.range[0]),tr.y(0)),ctx.lineTo(tr.x(obj.range[1]),tr.y(0)),ctx.stroke(),labels={xs:[],text:[]},kmax=opts.maxTicksLimit,k=0;k<=kmax;k++)labels.xs.push(obj.range[0]+obj.range[1]*k/kmax),labels.text.push(labels.xs[k]);for(labels.text=guesstimator.formatLabels(labels.text,opts.labels),guesstimator.fitFontForArray(labels.text,ctx,ctx.canvas.width,.4*borders.bottom,"",opts.fonts),ctx.textAlign="center",ctx.fillStyle=opts.axisColor,k=0;k<labels.text.length;k++)ctx.fillText(labels.text[k],tr.x(labels.xs[k]),ctx.canvas.height-.55*borders.bottom),ctx.beginPath(),ctx.moveTo(tr.x(labels.xs[k]),tr.y(0)),ctx.lineTo(tr.x(labels.xs[k]),tr.y(.05)),ctx.stroke();function plotPoint(j){ctx.beginPath(),x=tr.x(Math.min(obj.range[1],Math.max(obj.range[0],arr[j]))),y=tr.y(Math.random()),ctx.moveTo(x,y),ctx.arc(x,y,opts.pointRadius,0,2*Math.PI),ctx.fill()}ctx.fillText(opts.xLabel,ctx.canvas.width/2,ctx.canvas.height),fullTitle=[opts.showSeries,opts.title].join(" "),guesstimator.fitFontForArray(fullTitle,ctx,ctx.canvas.width,.7*borders.top,"",opts.fonts),ctx.fillText(fullTitle,ctx.canvas.width/2,.8*borders.top),ctx.fillStyle=pointColor,k=0,kmax=arr.length,delayFun&&clearInterval(delayFun),delayFun=setInterval(function(){for(var l=k+100;k<l;k++){if(!(document.body.contains(ctx.canvas)&&k<kmax)){clearInterval(delayFun);break}plotPoint(k)}},50)}return ctx.canvas.width="100%",guesstimator.events.addListener(window,"resize",createPlot,{set:obj.chartID,debounce:!0,ms:100}),createPlot},guesstimator.plot.overUnderPlot=function(obj){var ctx=guesstimator.appendCanvas(obj.chartElement);function getNum(vOrID,name){var h;if(vOrID)return guesstimator.isValidNum(vOrID)?h:Number(guesstimator.getVal(vOrID));throw new Error("A "+name+" value or input element ID string must be set.")}function createPlot(){var arr,series,h,l,lmhArr,colors,k,start,end,dims={};for(h=getNum(obj.options.highThreshold,"highThreshold"),(l=getNum(obj.options.lowThreshold,"lowThreshold"))>h&&(l=h,document.getElementById("lowThreshold").value=h),ctx.canvas.title=obj.options.canvasTitle||"Plot shows fraction of outcomes predicted to fall under, close to, or over budget.",series=obj.options.showSeries||"Total",lmhArr=(arr=obj.plotSeries[series].vals).reduce(function(lmh,x,j){return lmh[0]+=x<=l,lmh[1]+=x>l&&x<=h,lmh[2]+=x>h,lmh},[0,0,0]),colors=obj.options.thresholdColors||["#005421","#ffff00","#ff0000"],labels=obj.options.thresholdLabels||["Under budget","Watch out","Over budget"],ctx.canvas.width=Math.min(obj.chartElement.clientWidth,guesstimator.getWindowWidth()),ctx.canvas.height=Math.min(300,.75*guesstimator.getWindowWidth()),dims.xmid=ctx.canvas.width/2,dims.ymid=ctx.canvas.height/2,dims.r=Math.min(dims.xmid,.75*dims.ymid),dims.ycent=1.2*dims.ymid,ctx.fillStyle="#000000",ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height),ctx.fillRect(0,0,ctx.canvas.width,ctx.canvas.height),start=0,end=-Math.PI/2,ctx.textAlign="center",dims.fontSize=dims.xmid/guesstimator.maxElementLength(labels),ctx.font="bold "+dims.fontSize.toString()+"px Arial, Helvetica, sans-serif",k=2;k>=0;k--)ctx.beginPath(),ctx.moveTo(dims.xmid,dims.ycent),start=end,end+=2*Math.PI*lmhArr[k]/arr.length,ctx.arc(dims.xmid,dims.ycent,dims.r,start,end),ctx.fillStyle=colors[k],ctx.fill(),ctx.fillText(labels[k],(1+2*k)*dims.xmid/3,.25*dims.ymid)}return ctx.canvas.width="100%",guesstimator.events.addListener(window,"resize",createPlot,{set:obj.chartID,debounce:!0,ms:100}),createPlot},guesstimator.getWindowHeight=function(){return window.innerHeight||document.documentElement.clientHeight||document.body.clientHeight},guesstimator.getWindowWidth=function(){return window.innerWidth||document.documentElement.clientWidth||document.body.clientWidth},guesstimator.maxElementLength=function(arr){return arr.reduce(function(accumulator,curVal,curInd,srcArr){return srcArr[curInd].length?Math.max(accumulator,srcArr[curInd].length):accumulator},0)},guesstimator.fitFontForArray=function(arr,ctxInner,w,h,fontStyling,fontGroup){var maxWidth=w/arr.length,k,curWidth,lastWidth,jMax;for(k=0,jMax=0,curWidth=0,lastWidth=0;k<arr.length;k++)(curWidth=ctxInner.measureText(arr[k]).width)>lastWidth&&(jmax=k,lastWidth=curWidth);function setFont(x){ctxInner.font=[fontStyling,x.toString()+"px",fontGroup].join(" ")}for(setFont(h);maxWidth<ctxInner.measureText(arr[jmax]).width&&h>2;)setFont(--h)},guesstimator.formatLabels=function(ticks,opts){var out,suffix,prefix,key,special={firstTick:0,lastTick:ticks.length-1},opts=opts||{};if(ticks&&Array.isArray(ticks)&&ticks.length>=1)for(key in suffix=(opts.suffix||"").toString(),prefix=(opts.prefix||"").toString(),out=ticks.map(function(x){var y=isNaN(x)||isNaN(opts.multiplier)?x:x*opts.multiplier;return y=isNaN(y)||isNaN(opts.decimals)?y.toString():y.toFixed(opts.decimals),y=prefix+y+suffix}),special)opts[key]&&(prefix=(opts[key].prefix||"").toString(),suffix=(opts[key].suffix||"").toString(),out[special[key]]=prefix+out[special[key]]+suffix);return out},guesstimator.model=function(xDists,modelFun,chartID,opts){var gs={xDists:guesstimator.deepCopy(xDists),modelFun:guesstimator.deepCopy(modelFun),chartID:chartID},k;return gs.n=opts.n||500,guesstimator.events.removeListenersInSet(chartID),gs.chartElement=document.getElementById(chartID),gs.options=opts?guesstimator.deepCopy(opts):{},gs.chartElement.innerHTML="",gs.chart=null,gs.options.chartType=gs.options.chartType||"histogram",gs.createOrUpdateChart=guesstimator.plot[gs.options.chartType]?guesstimator.plot[gs.options.chartType](gs):guesstimator.plot.histogram(gs),gs.update=function(){var j,curval,item,arr;function recalculate(obj,n){var arr,out;if(obj.distribution)arr=obj.transform?guesstimator[obj.transform](obj.params):obj.params,out=guesstimator.distributions[obj.distribution](n,arr);else{if(isNaN(obj))throw new Error("Incorrect form for: "+JSON.stringify(obj));out=obj}return out}for(item in gs.xs=gs.xs||{},gs.choices=gs.choices||{},gs.xDists)if(gs.xDists[item].hasOwnProperty("fixed"))gs.xs[item]||(gs.xs[item]=recalculate(xDists[item].fixed,gs.n));else if(gs.xDists[item].hasOwnProperty("select"))curval=guesstimator.getVal(item),gs.choices[item]!==curval&&(gs.choices[item]=curval,gs.xs[item]=recalculate(gs.xDists[item].select[curval],gs.n));else{if(!gs.xDists[item].hasOwnProperty("input")||!gs.xDists[item].input.paramIDs)throw new Error("Incorrect type for "+gs.xDists[item]);for(curval=[],arr=gs.xDists[item].input.paramIDs,j=0;j<arr.length;j++)curval.push(Number(guesstimator.getVal(arr[j])));gs.choices[item]&&gs.choices[item].every(function(x,k){return x===curval[k]})||(gs.choices[item]=curval,gs.xDists[item].input.params=curval,gs.xs[item]=recalculate(gs.xDists[item].input,gs.n))}gs.plotSeries=gs.modelFun(gs.xs),"histogram"!==gs.options.chartType&&"scatter"!==gs.options.chartType||(gs.range=guesstimator.createRange(gs.plotSeries,gs.options.range,gs.options.rangeSDs,"vals")),gs.createOrUpdateChart()},gs.update(),guesstimator.events.addListener(document,"change",gs.update,{set:chartID,debounce:!0,ms:gs.options.delay||50}),gs},guesstimator.getVal=function(IDstr){if(!document.getElementById(IDstr))throw new Error("No DOM element found for '"+IDstr+"'");return document.getElementById(IDstr).value},guesstimator.createRange=function(obj,arr,sds,str){var rng=[],k,params={},curdata,x,xscale,sds=guesstimator.isValidNum(sds)?sds:1.5;for(k=0;k<2;k++)obj.hasOwnProperty(arr[k])?(params.hasOwnProperty(arr[k])||(curdata=void 0!==typeof str?obj[arr[k]][str]:obj[arr[k]],params[arr[k]]={mean:guesstimator.mean(curdata),sd:guesstimator.stdev(curdata)}),x=params[arr[k]].mean+sds*params[arr[k]].sd*(1===k?1:-1),xscale=Math.pow(10,Math.floor(Math.log(Math.abs(x))/Math.log(10))),rng.push(1===k?xscale*Math.ceil(x/xscale):xscale*Math.floor(x/xscale))):guesstimator.isValidNum(arr[k])&&rng.push(arr[k]);return rng},guesstimator.deepCopy=function(objParent){var prevObjs=[],copiedObjs=[];function deepCopyInner(obj){var out,k;if("object"!=typeof obj||null===obj)out=obj;else if("object"==typeof obj)if((k=prevObjs.indexOf(obj))>=0)out=copiedObjs[k];else if(prevObjs.push(obj),Array.isArray(obj))for(out=[],copiedObjs.push(out),k=0;k<obj.length;k++)out.push(deepCopyInner(obj[k]));else if(obj&&"[object Date]"===Object.prototype.toString.call(obj)&&!isNaN(obj))out=new Date(obj.getTime()),copiedObjs.push(out);else if(obj)for(k in out={},copiedObjs.push(out),obj)out[k]=deepCopyInner(obj[k]);return out}return deepCopyInner(objParent)},guesstimator.deepMerge=function(objParent1,objParent2){var prevObjs=[];function deepMergeInner(obj1,obj2){var out,k,key;if("[object Object]"!==Object.prototype.toString.call(obj1))out=guesstimator.deepCopy(obj2);else if("[object Object]"!==Object.prototype.toString.call(obj2))out=guesstimator.deepCopy(obj2);else if(obj2&&"object"==typeof obj2){for(out={},k=0;k<prevObjs.length;k++)if(prevObjs[k][0]===obj1&&prevObjs[k][1]===obj2){out=prevObj[k][2],k=prevObjs.length;break}if(k===prevObjs.length){for(key in prevObjs.push([obj1,obj2,out]),obj1)obj2[key]?out[key]=deepMergeInner(obj1[key],obj2[key]):out[key]=guesstimator.deepCopy(obj1[key]);for(key in obj2)out[key]||(out[key]=guesstimator.deepCopy(obj2[key]))}}return out}return deepMergeInner(objParent1,objParent2)},guesstimator.events=function(){var ev={},numListenersCreated=0;function debounce(func,timeout){var timeoutID,timeout=timeout||200;return function(){var scope=this,args=arguments;clearTimeout(timeoutID),timeoutID=setTimeout(function(){func.apply(scope,Array.prototype.slice.call(args))},timeout)}}return ev.listeners={},ev.addListener=function(el,str,func,opts){var obj={target:el,event:str},opts,key="L";key+=++numListenersCreated;var ms="number"==typeof(opts=opts||{}).ms?opts.ms:200;return obj.listener=!0===opts.debounce?debounce(func,ms):func,el.addEventListener(str,obj.listener),"string"!=typeof opts.set&&"number"!=typeof opts.set||(obj.set=opts.set,ev.sets||(ev.sets={}),ev.sets[opts.set]||(ev.sets[opts.set]={}),ev.sets[opts.set][key]=!0),ev.listeners[key]=obj,key},ev.removeAllGuesstimatorListeners=function(){var key,obj;for(key in ev.listeners)(obj=ev.listeners[key]).target.removeEventListener(obj.event,obj.listener)},ev.removeListenersInSet=function(str){var key;if(ev.sets&&ev.sets[str]){for(key in ev.sets[str])ev.removeGuesstimatorListener(key);delete ev.sets[str]}},ev.removeGuesstimatorListener=function(key){var obj=ev.listeners[key];obj.target.removeEventListener(obj.event,obj.listener),obj.set&&delete ev.sets[obj.set][key],delete ev.listeners[key]},ev}(),guesstimator.genScalings=function(xmin,ymin,xmax,ymax){function genScaleFun(min,max){return function(dx){return dx*(max[1]-min[1])/(max[0]-min[0])}}function genCoordTransform(min,max){var slope=genScaleFun(min,max)(1),intercept=min[1]-slope*min[0];return function(x){return intercept+slope*x}}return{x:genCoordTransform(xmin,xmax),y:genCoordTransform(ymin,ymax),w:genScaleFun(xmin,xmax),h:genScaleFun(ymin,ymax)}};